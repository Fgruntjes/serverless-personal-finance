name: Integration tests
on:
    pull_request:

jobs:
    deploy_slug:
        runs-on: ubuntu-latest
        steps:
        -   uses: rlespinasse/github-slug-action@v4
        -   id: environment
            run: echo "var=it-${{ env.GITHUB_REF_SLUG_URL }}" >> $GITHUB_OUTPUT
        -   id: tag
            run: echo "var=${{ env.GITHUB_SHA_SHORT }}" >> $GITHUB_OUTPUT
        outputs:
            environment: ${{ steps.environment.outputs.var }}
            tag: ${{ steps.tag.outputs.var }}

    build:
        needs: [deploy_slug]
        uses: ./.github/workflows/build.yaml
        secrets: inherit
        with:
            environment: ${{ needs.deploy_slug.outputs.environment }}
            tag: ${{ needs.deploy_slug.outputs.tag }}
    
    deploy:
        needs: [deploy_slug, build]
        uses: ./.github/workflows/deploy.yaml
        secrets: inherit
        concurrency: 
            group: ${{ needs.deploy_slug.outputs.environment }}
            cancel-in-progress: true
        with:
            environment: ${{ needs.deploy_slug.outputs.environment }}
            tag: ${{ needs.deploy_slug.outputs.tag }}
        
    test:
        runs-on: ubuntu-latest
        needs: [deploy_slug, deploy]
        concurrency:
            group: ${{ needs.deploy_slug.outputs.environment }}
            cancel-in-progress: true
        steps:
        -   run: echo "Do some integration tests on this tmp environment"
            
    delete:
        needs: [deploy_slug, test]
        uses: ./.github/workflows/delete.yaml
        secrets: inherit
        concurrency:
            group: ${{ needs.deploy_slug.outputs.environment }}
            cancel-in-progress: true
        if: ${{ always() }}
        with:
            environment: ${{ needs.deploy_slug.outputs.environment }}
